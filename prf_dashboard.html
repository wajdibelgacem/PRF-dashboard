<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PRF Election Summary (Constrained Optimum)</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --card2:#0c1629;
      --text:#eef2ff;
      --muted:#b6c2ffcc;
      --line:#22304f;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% 0%, rgba(124,58,237,.35), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.22), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.45;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 60px}
    .hero{
      display:flex;gap:18px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:18px;
    }
    .title{font-size:28px;font-weight:800;letter-spacing:.2px;margin:0;}
    .subtitle{margin-top:6px;color:var(--muted);max-width:70ch}
    .chiprow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:7px 10px;border-radius:999px;
      color:var(--muted);font-size:13px;
    }
    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:16px 16px 14px;
    }
    .card h3{margin:0 0 10px 0;font-size:16px;letter-spacing:.2px;}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{min-width:220px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="file"], select, button{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,16,30,.65);
      color:var(--text);
      outline:none;
    }
    select:disabled{opacity:.6}
    button{
      width:auto;
      background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(99,102,241,.95));
      border:1px solid rgba(255,255,255,.16);
      cursor:pointer;
      font-weight:700;
      padding:11px 14px;
    }
    button.secondary{background: rgba(255,255,255,.06);font-weight:600;}
    .status{margin-top:7px;font-size:12px;color:var(--muted);}
    .status.ok{color: rgba(34,197,94,.95)}
    .status.bad{color: rgba(251,113,133,.95)}
    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      flex:1;
      min-width:210px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px 12px 10px;
    }
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:22px;font-weight:850;margin-top:4px}
    .kpi .s{font-size:12px;color:var(--muted);margin-top:4px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{
      padding:6px 10px;border-radius:999px;font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .pill.green{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.12)}
    .pill.purple{border-color:rgba(124,58,237,.55);background:rgba(124,58,237,.12)}
    .pill.yellow{border-color:rgba(251,191,36,.55);background:rgba(251,191,36,.12)}
    .pill.red{border-color:rgba(251,113,133,.55);background:rgba(251,113,133,.12)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .divider{height:1px;background:var(--line);margin:12px 0}
    details{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(0,0,0,.14);
    }
    summary{cursor:pointer;color:var(--text);font-weight:700}
    .small{font-size:12px;color:var(--muted)}
    .callout{
      margin-top:12px;
      padding:12px 12px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(124,58,237,.10);
    }
    .callout b{color:var(--text)}
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin: 10px 0 0 0;
    }
    .topbar .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{
      padding:6px 10px;border-radius:999px;font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      color: var(--muted);
    }
    .linkbtn{
      text-decoration:none;display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:700;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1 class="title">PRF election summary (constrained optimum)</h1>
        <div class="subtitle">
          Choose a State → County → Grid to see the recommended interval weights and what historical rainfall suggests about payout frequency and average net return.
        </div>
        <div class="chiprow">
          <div class="chip">Uses your optimal-election file</div>
          <div class="chip">Uses historical rainfall index (GRID × year)</div>
          <div class="chip">Shows an “any payout” probability</div>
        </div>

        <div class="topbar">
          <div class="left">
            <span id="modeBadge" class="badge">Data source: (loading…)</span>
            <span class="badge">Tip: Put the 3 .txt files in the same website folder as this HTML.</span>
          </div>
          <a class="linkbtn" href="." onclick="location.reload(); return false;">Reload</a>
        </div>
      </div>

      <div class="chip" style="max-width:360px">
        <b>Note</b>: This is a historical summary, not a guarantee. Payments depend on the published NOAA/CPC grid index and your final election.
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Step 1 — Load your files</h3>
        <div class="small" style="margin:0 0 10px 0">
          <b>Automatic mode</b> tries to load files from the website. If that fails, use manual upload below.
        </div>

        <div class="row">
          <div class="field">
            <div class="label">Directory (State–County–Grid)</div>
            <input id="fileDir" type="file" accept=".txt,.csv" />
            <div id="statusDir" class="status">Load state_county_grid_directory (pipe-delimited).</div>
          </div>

          <div class="field">
            <div class="label">PRF optimal elections</div>
            <input id="filePrf" type="file" accept=".txt,.csv" />
            <div id="statusPrf" class="status">Load PRF_OPTIMAL_ELECTION_allcounties.txt (pipe-delimited).</div>
          </div>

          <div class="field">
            <div class="label">Rainfall index history</div>
            <input id="fileRain" type="file" accept=".txt,.csv" />
            <div id="statusRain" class="status">Load rainfall_long_only_clean.txt (GRIDCODE|Year|interval_code|rainfall_index).</div>
          </div>
        </div>

        <div class="divider"></div>

        <h3>Step 2 — Select a location</h3>
        <div class="row">
          <div class="field">
            <div class="label">State</div>
            <select id="selState" disabled><option value="">(load files)</option></select>
          </div>

          <div class="field">
            <div class="label">County</div>
            <select id="selCounty" disabled><option value="">(select state)</option></select>
          </div>

          <div class="field">
            <div class="label">Grid</div>
            <select id="selGrid" disabled><option value="">(select county)</option></select>
          </div>

          <div style="padding-bottom:2px">
            <button id="btnClear" class="secondary">Clear</button>
          </div>
        </div>

        <div class="small" style="margin-top:10px">
          Tip: The recommendation is specific to the selected grid and uses your constrained optimization results (weights, non-overlap, caps).
        </div>
      </div>

      <div class="card">
        <h3>Results</h3>
        <div id="out" class="muted">Loading…</div>
      </div>
    </div>

    <div class="small" style="margin-top:14px">
      Built for quick communication. A “Technical details” section is included inside each result for research and auditing.
    </div>
  </div>

<script>
(() => {
  const months = {
    "625":"Jan–Feb","626":"Feb–Mar","627":"Mar–Apr","628":"Apr–May","629":"May–Jun",
    "630":"Jun–Jul","631":"Jul–Aug","632":"Aug–Sep","633":"Sep–Oct","634":"Oct–Nov","635":"Nov–Dec"
  };

  const stateName = { "31":"Nebraska", "38":"North Dakota", "46":"South Dakota" };

  function subsidy(CL) {
    if (CL === 0.70 || CL === 0.75) return 0.59;
    if (CL === 0.80 || CL === 0.85) return 0.55;
    return 0.51;
  }

  let tree = {};
  let detail = {};
  let rain = {};
  let readyDir = false, readyPrf = false, readyRain = false;

  const $ = id => document.getElementById(id);
  const out = $("out");
  const selState = $("selState");
  const selCounty = $("selCounty");
  const selGrid = $("selGrid");
  const modeBadge = $("modeBadge");

  function setModeLabel(txt){ modeBadge.textContent = "Data source: " + txt; }

  function resetSelectors() {
    selState.innerHTML = `<option value="">(load files)</option>`;
    selCounty.innerHTML = `<option value="">(select state)</option>`;
    selGrid.innerHTML = `<option value="">(select county)</option>`;
    selState.disabled = true;
    selCounty.disabled = true;
    selGrid.disabled = true;
    out.innerHTML = "Load files and select State → County → Grid.";
  }

  function parseDir(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    const t = {};
    for (const line of lines) {
      const p = line.split("|");
      if (p.length < 4) continue;
      const st = p[0].trim();
      const co = String(parseInt(p[1].trim(),10));
      const nm = p[2].trim();
      const g  = p[3].trim();
      if (!st || !co || !g) continue;
      if (!t[st]) t[st] = {};
      if (!t[st][co]) t[st][co] = { name: nm || "", grids: [] };
      t[st][co].grids.push(g);
    }
    for (const st of Object.keys(t)) {
      for (const co of Object.keys(t[st])) {
        t[st][co].grids = Array.from(new Set(t[st][co].grids)).sort((a,b)=> (+a)-(+b));
      }
    }
    return t;
  }

  function parsePrf(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    if (lines.length < 2) throw new Error("PRF file looks empty.");
    const header = lines[0].split("|").map(s => s.trim());
    const idx = {};
    header.forEach((h,i)=> idx[h]=i);

    const need = [
      "GRIDCODE","state_code","county_code","CL_star",
      "obj_star_per_dollar_liability","K_star_interval_codes","w_star",
      "PF_star","county_base_value","expected_profit_per_acre"
    ];
    for (const k of need) if (!(k in idx)) throw new Error("Missing column: " + k);

    const d = {};
    for (let i=1; i<lines.length; i++) {
      const p = lines[i].split("|");
      if (p.length < header.length) continue;

      const grid = p[idx["GRIDCODE"]].trim();
      const st = p[idx["state_code"]].trim();
      const co = String(parseInt(p[idx["county_code"]].trim(),10));

      const r = {
        GRIDCODE: grid,
        state_code: st,
        county_code: co,
        CL_star: p[idx["CL_star"]].trim(),
        obj: p[idx["obj_star_per_dollar_liability"]].trim(),
        Kpair: p[idx["K_star_interval_codes"]].trim(),
        w_star: p[idx["w_star"]].trim(),
        PF_star: p[idx["PF_star"]].trim(),
        cbv: p[idx["county_base_value"]].trim(),
        epa: p[idx["expected_profit_per_acre"]].trim()
      };

      const ks = r.Kpair.split(",").map(s => s.trim());
      r.k1 = ks[0] || ""; r.k2 = ks[1] || "";
      r.m1 = months[r.k1] || r.k1;
      r.m2 = months[r.k2] || r.k2;

      r.w1 = 0; r.w2 = 0;
      const wparts = r.w_star.split(",").map(s => s.trim());
      for (const wp of wparts) {
        const parts = wp.split(":");
        const k = (parts[0] || "").trim();
        const v = (parts[1] || "").trim();
        if (k === r.k1) r.w1 = parseFloat(v);
        if (k === r.k2) r.w2 = parseFloat(v);
      }

      d[st + "|" + co + "|" + grid] = r;
    }
    return d;
  }

  function parseRain(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    if (lines.length < 2) throw new Error("Rainfall file looks empty.");
    const r = {};
    for (let i=0; i<lines.length; i++) {
      const p = lines[i].split("|");
      if (p.length < 4) continue;
      const g = p[0].trim();
      const y = parseInt(p[1].trim(), 10);
      const k = parseInt(p[2].trim(), 10);
      const ri = parseFloat(p[3].trim());
      if (!g || !Number.isFinite(y) || !Number.isFinite(k) || !Number.isFinite(ri)) continue;
      if (!r[g]) r[g] = {};
      if (!r[g][y]) r[g][y] = {};
      r[g][y][k] = ri;
    }
    return r;
  }

  function fillStates() {
    selState.innerHTML = `<option value="">(select state)</option>`;
    const sts = Object.keys(tree).sort((a,b)=> (+a)-(+b));
    for (const st of sts) {
      const label = stateName[st] ? `${stateName[st]} (${st})` : st;
      const opt = document.createElement("option");
      opt.value = st;
      opt.textContent = label;
      selState.appendChild(opt);
    }
    selState.disabled = false;
  }

  function fillCounties(st) {
    selCounty.innerHTML = `<option value="">(select county)</option>`;
    selGrid.innerHTML = `<option value="">(select grid)</option>`;
    selCounty.disabled = true;
    selGrid.disabled = true;
    out.innerHTML = "";
    if (!st || !tree[st]) return;

    const cos = Object.keys(tree[st]).sort((a,b)=> (+a)-(+b));
    for (const co of cos) {
      const nm = tree[st][co].name;
      const label = nm ? `${nm} (${co})` : co;
      const opt = document.createElement("option");
      opt.value = co;
      opt.textContent = label;
      selCounty.appendChild(opt);
    }
    selCounty.disabled = false;
  }

  function fillGrids(st, co) {
    selGrid.innerHTML = `<option value="">(select grid)</option>`;
    selGrid.disabled = true;
    out.innerHTML = "";
    if (!st || !co || !tree[st] || !tree[st][co]) return;

    for (const g of tree[st][co].grids) {
      const opt = document.createElement("option");
      opt.value = g;
      opt.textContent = g;
      selGrid.appendChild(opt);
    }
    selGrid.disabled = false;
  }

  function computeStats(grid, k, CL) {
    const g = rain[grid];
    if (!g) return null;
    let n=0, pay=0, sumPCF=0, sumRI=0;
    for (const yStr of Object.keys(g)) {
      const y = parseInt(yStr,10);
      const riy = g[y]?.[k];
      if (!Number.isFinite(riy)) continue;
      n++;
      sumRI += riy;
      if (riy < CL) {
        pay++;
        sumPCF += (CL - riy) / CL;
      }
    }
    if (n === 0) return null;
    return { n, pPay: pay / n, meanRI: sumRI / n, meanPCF: sumPCF / n };
  }

  function computeAnyPay(grid, k1, k2, CL) {
    const g = rain[grid];
    if (!g) return null;
    let n=0, any=0, both=0, none=0;
    for (const y in g) {
      const a = g[y][k1];
      const b = g[y][k2];
      if (a == null || b == null) continue;
      n++;
      const payA = a < CL;
      const payB = b < CL;
      if (payA || payB) any++;
      if (payA && payB) both++;
      if (!payA && !payB) none++;
    }
    if (n === 0) return null;
    return { n, pAny:any/n, pBoth:both/n, pNone:none/n };
  }

  function render(st, co, grid) {
    const key = st + "|" + co + "|" + grid;
    const r = detail[key];
    if (!r) {
      out.innerHTML = `<div class="pill red">No result found for this State–County–Grid.</div>`;
      return;
    }

    const stLabel = stateName[st] ? `${stateName[st]} (${st})` : st;
    const coLabel = tree?.[st]?.[co]?.name ? `${tree[st][co].name} (${co})` : co;

    const CL = parseFloat(r.CL_star);
    const PF = parseFloat(r.PF_star);
    const cbv = parseFloat(r.cbv);
    const obj = parseFloat(r.obj);
    const s = subsidy(CL);

    const rec = `
      <div class="pillrow">
        <span class="pill purple"><b>Recommended</b>: ${r.m2} (${r.k2}) ${Math.round(100*r.w2)}% + ${r.m1} (${r.k1}) ${Math.round(100*r.w1)}%</span>
        <span class="pill"><b>Coverage</b>: CL ${r.CL_star}</span>
        <span class="pill"><b>Productivity</b>: PF ${r.PF_star}</span>
      </div>
    `;

    if (!readyRain) {
      out.innerHTML = `
        <div>
          <div class="small">State: <b>${stLabel}</b> · County: <b>${coLabel}</b> · Grid: <b class="mono">${grid}</b></div>
          ${rec}
          <div class="divider"></div>
          <div class="kpiRow">
            <div class="kpi">
              <div class="k">Expected net return</div>
              <div class="v">${parseFloat(r.epa).toFixed(2)} <span class="small">$/acre</span></div>
              <div class="s">From your optimization file</div>
            </div>
            <div class="kpi">
              <div class="k">Net per $1 liability</div>
              <div class="v">${obj.toFixed(4)}</div>
              <div class="s">Comparable across counties</div>
            </div>
            <div class="kpi">
              <div class="k">County base value</div>
              <div class="v">${cbv.toFixed(1)}</div>
              <div class="s">Scales dollars per acre</div>
            </div>
          </div>
          <div class="callout">
            <b>To add payout probabilities</b>, load the rainfall history file (GRIDCODE|Year|interval_code|rainfall_index).
          </div>
          <details>
            <summary>Technical details</summary>
            <div class="small" style="margin-top:8px">
              Objective per $ liability = <span class="mono">${r.obj}</span><br/>
              Intervals: <span class="mono">${r.k1}</span> (w=${r.w1.toFixed(4)}), <span class="mono">${r.k2}</span> (w=${r.w2.toFixed(4)})
            </div>
          </details>
        </div>
      `;
      return;
    }

    const s1 = computeStats(grid, parseInt(r.k1,10), CL);
    const s2 = computeStats(grid, parseInt(r.k2,10), CL);
    const any = computeAnyPay(grid, parseInt(r.k1,10), parseInt(r.k2,10), CL);

if (!(s1 && s2)) {
  out.innerHTML = `<div class="pill red">
    Rainfall history loaded, but one interval series is missing for this grid.
  </div>`;
  return;
}

// overlap may be missing — not fatal
const overlapN = any ? any.n : 0;

    const wEPCF = r.w1*s1.meanPCF + r.w2*s2.meanPCF;
    const wR = (wEPCF - obj) / (1.0 - s);

    const indemn_per_acre = cbv * CL * PF * wEPCF;
    const prem_producer_per_acre = (1.0 - s) * cbv * CL * PF * wR;
    const net_per_acre = indemn_per_acre - prem_producer_per_acre;

    const p1 = 100*s1.pPay, p2 = 100*s2.pPay;
    const pany = 100*any.pAny, pboth = 100*any.pBoth, pnone = 100*any.pNone;

    out.innerHTML = `
      <div>
        <div class="small">State: <b>${stLabel}</b> · County: <b>${coLabel}</b> · Grid: <b class="mono">${grid}</b></div>
        ${rec}

        <div class="divider"></div>

        <<div class="kpiRow">
          <div class="kpi">
            <div class="k">Expected net return</div>
            <div class="v">${net_per_acre.toFixed(2)} <span class="small">$/acre</span></div>
            <div class="s">Historical mean: indemnity − producer premium</div>
          </div>
          <div class="kpi">
            <div class="k">Chance of any payout</div>
            <div class="v">${pany.toFixed(1)}%</div>
            <div class="s">${any.n} historical years in file</div>
          </div>
          <div class="kpi">
            <div class="k">No-payout years</div>
            <div class="v">${pnone.toFixed(1)}%</div>
            <div class="s">Both-interval payout: ${pboth.toFixed(1)}%</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="pillrow">
          <span class="pill green"><b>${r.m1}</b>: pays in ${p1.toFixed(1)}% of years · average payout factor ${s1.meanPCF.toFixed(3)}</span>
          <span class="pill green"><b>${r.m2}</b>: pays in ${p2.toFixed(1)}% of years · average payout factor ${s2.meanPCF.toFixed(3)}</span>
          <span class="pill yellow"><b>Subsidy</b>: ${Math.round(100*s)}% (producer share ${Math.round(100*(1-s))}%)</span>
        </div>

        <div class="callout">
          <b>What this means</b>: Based on the historical rainfall index for this grid, this election paid at least once in about
          <b>${pany.toFixed(1)}%</b> of years. On average, the model implies <b>${net_per_acre.toFixed(2)} $/acre</b> net of the producer premium.
          Your actual outcome can differ because rainfall and program rates vary year to year.
        </div>

        <details>
          <summary>Technical details</summary>
          <div class="small" style="margin-top:8px">
            <div><b>Intervals & weights</b>: <span class="mono">${r.k1}</span> (${r.m1}) w=${r.w1.toFixed(4)} · <span class="mono">${r.k2}</span> (${r.m2}) w=${r.w2.toFixed(4)}</div>
            <div><b>CL</b>: <span class="mono">${r.CL_star}</span> · <b>PF</b>: <span class="mono">${r.PF_star}</span></div>
            <div><b>Objective per $ liability</b>: <span class="mono">${r.obj}</span></div>
            <div><b>Weighted E[PCF]</b>: <span class="mono">${wEPCF.toFixed(5)}</span></div>
            <div><b>Implied weighted base rate</b> (w·r): <span class="mono">${wR.toFixed(5)}</span> per $ liability</div>
            <div><b>Expected indemnity</b>: <span class="mono">${indemn_per_acre.toFixed(4)}</span> $/acre</div>
            <div><b>Expected producer premium</b>: <span class="mono">${prem_producer_per_acre.toFixed(4)}</span> $/acre</div>
            <div><b>Cross-check net</b>: <span class="mono">${net_per_acre.toFixed(4)}</span> (file: ${parseFloat(r.epa).toFixed(4)})</div>
            <div class="divider"></div>
            <div><b>Interval stats</b>:</div>
            <div class="mono">
              ${r.k1}: Pr(RI&lt;CL)=${(100*s1.pPay).toFixed(1)}% · E[PCF]=${s1.meanPCF.toFixed(4)} · mean RI=${s1.meanRI.toFixed(3)} · n=${s1.n}<br/>
              ${r.k2}: Pr(RI&lt;CL)=${(100*s2.pPay).toFixed(1)}% · E[PCF]=${s2.meanPCF.toFixed(4)} · mean RI=${s2.meanRI.toFixed(3)} · n=${s2.n}<br/>
              Any payout=${(100*any.pAny).toFixed(1)}% · Both=${(100*any.pBoth).toFixed(1)}% · None=${(100*any.pNone).toFixed(1)}% · years=${any.n}
            </div>
          </div>
        </details>
      </div>
    `;
  }

  selState.addEventListener("change", () => fillCounties(selState.value));
  selCounty.addEventListener("change", () => fillGrids(selState.value, selCounty.value));
  selGrid.addEventListener("change", () => {
    const st = selState.value, co = selCounty.value, g = selGrid.value;
    if (st && co && g) render(st, co, g);
  });

  $("btnClear").addEventListener("click", () => {
    tree = {}; detail = {}; rain = {};
    readyDir = readyPrf = readyRain = false;
    $("fileDir").value = ""; $("filePrf").value = ""; $("fileRain").value = "";
    $("statusDir").textContent = "Load state_county_grid_directory (pipe-delimited).";
    $("statusPrf").textContent = "Load PRF_OPTIMAL_ELECTION_allcounties.txt (pipe-delimited).";
    $("statusRain").textContent = "Load rainfall_long_only_clean.txt (GRIDCODE|Year|interval_code|rainfall_index).";
    setModeLabel("manual upload");
    resetSelectors();
  });

  $("fileDir").addEventListener("change", async (e) => {
    const f = e.target.files?.[0]; if (!f) return;
    $("statusDir").textContent = "Reading directory…";
    try {
      tree = parseDir(await f.text());
      readyDir = true;
      $("statusDir").innerHTML = `<span class="ok">Loaded directory.</span>`;
      setModeLabel("manual upload");
      if (readyPrf) { fillStates(); out.innerHTML = `<div class="card"><span class="ok">Ready.</span> Pick State → County → Grid.</div>`; }
      else { out.innerHTML = `<div class="card"><span class="muted">Now load PRF results file.</span></div>`; }
    } catch (err) {
      tree = {}; readyDir = false;
      $("statusDir").innerHTML = `<span class="bad">Error:</span> ${String(err.message || err)}`;
      resetSelectors();
    }
  });

  $("filePrf").addEventListener("change", async (e) => {
    const f = e.target.files?.[0]; if (!f) return;
    $("statusPrf").textContent = "Reading PRF results…";
    try {
      detail = parsePrf(await f.text());
      readyPrf = true;
      $("statusPrf").innerHTML = `<span class="ok">Loaded PRF results.</span>`;
      setModeLabel("manual upload");
      if (readyDir) { fillStates(); out.innerHTML = `<div class="card"><span class="ok">Ready.</span> Pick State → County → Grid.</div>`; }
      else { out.innerHTML = `<div class="card"><span class="muted">Now load directory file.</span></div>`; }
    } catch (err) {
      detail = {}; readyPrf = false;
      $("statusPrf").innerHTML = `<span class="bad">Error:</span> ${String(err.message || err)}`;
      resetSelectors();
    }
  });

  $("fileRain").addEventListener("change", async (e) => {
    const f = e.target.files?.[0]; if (!f) return;
    $("statusRain").textContent = "Reading rainfall history…";
    try {
      rain = parseRain(await f.text());
      readyRain = true;
      $("statusRain").innerHTML = `<span class="ok">Loaded rainfall history.</span>`;
      setModeLabel("manual upload");
      const st = selState.value, co = selCounty.value, g = selGrid.value;
      if (st && co && g) render(st, co, g);
    } catch (err) {
      rain = {}; readyRain = false;
      $("statusRain").innerHTML = `<span class="bad">Error:</span> ${String(err.message || err)}`;
    }
  });

  async function autoloadHostedData() {
    try {
      setModeLabel("auto (website)");
      $("statusDir").textContent = "Loading directory from website…";
      $("statusPrf").textContent = "Loading PRF results from website…";
      $("statusRain").textContent = "Loading rainfall history from website…";
      out.textContent = "Loading hosted data…";

      const [dirText, prfText, rainText] = await Promise.all([
        fetch("state_county_grid_directory.txt", {cache:"no-store"}).then(r => { if(!r.ok) throw new Error("Missing state_county_grid_directory.txt"); return r.text(); }),
        fetch("PRF_OPTIMAL_ELECTION_allcounties.txt", {cache:"no-store"}).then(r => { if(!r.ok) throw new Error("Missing PRF_OPTIMAL_ELECTION_allcounties.txt"); return r.text(); }),
        fetch("rainfall_long_only_clean.txt", {cache:"no-store"}).then(r => { if(!r.ok) throw new Error("Missing rainfall_long_only_clean.txt"); return r.text(); })
      ]);

      tree = parseDir(dirText); readyDir = true; $("statusDir").innerHTML = `<span class="ok">Loaded directory.</span>`;
      detail = parsePrf(prfText); readyPrf = true; $("statusPrf").innerHTML = `<span class="ok">Loaded PRF results.</span>`;
      rain = parseRain(rainText); readyRain = true; $("statusRain").innerHTML = `<span class="ok">Loaded rainfall history.</span>`;

      fillStates();
      out.innerHTML = `<div class="card"><span class="ok">Ready.</span> Pick State → County → Grid.</div>`;
    } catch (err) {
      setModeLabel("manual upload (auto failed)");
      $("statusDir").innerHTML = `<span class="bad">Auto-load failed.</span>`;
      $("statusPrf").innerHTML = `<span class="bad">Auto-load failed.</span>`;
      $("statusRain").innerHTML = `<span class="bad">Auto-load failed.</span>`;
      out.innerHTML = `<div class="pill red">Auto-load failed: ${String(err.message || err)}. Use manual file upload.</div>`;
    }
  }

  resetSelectors();
  autoloadHostedData();
})();
</script>

</body>
</html>
